{"properties":{"connectionReferences":{"shared_commondataserviceforapps_3":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_commondataserviceforapps"}},"shared_office365":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_office365"}},"shared_approvals":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_approvals"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"When_a_Cancellation_Request_is_created":{"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"SubscribeWebhookTrigger","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"subscriptionRequest/message":1,"subscriptionRequest/entityname":"ovs_cancellationrequest","subscriptionRequest/scope":4},"authentication":"@parameters('$authentication')"}}},"actions":{"Initialize_Base_Work_Order_URL":{"runAfter":{"Get_Related_Work_Order":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Base Work Order URL","type":"string","value":"https://@{uriHost(body('Get_Related_Work_Order')?['@odata.id'])}/main.aspx?forceUCI=1&pagetype=entityrecord&etn=msdyn_workorder&id="}]}},"Initialize_Cancellation_Requested_GUID":{"runAfter":{"Initialize_Base_Work_Order_URL":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Cancellation Requested Substatus GUID","type":"string","value":"6bd7472c-1025-eb11-a813-000d3af3e51b"}]}},"Initialize_variable":{"runAfter":{"Initialize_Cancellation_Requested_GUID":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Approval Result","type":"string","value":"Rejected"}]}},"Get_User_Requesting_Cancellation":{"runAfter":{"IsLanguageFrench":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@triggerOutputs()?['body/_ownerid_value']"},"authentication":"@parameters('$authentication')"}},"Get_Work_Owner_Owner":{"runAfter":{"Get_User_Requesting_Cancellation":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@outputs('Get_Related_Work_Order')?['body/_ownerid_value']"},"authentication":"@parameters('$authentication')"}},"Update_Substatus_of_Work_Order":{"runAfter":{"Get_Owner's_Manager":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"msdyn_workorders","recordId":"@outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']","item/msdyn_substatus@odata.bind":"msdyn_workordersubstatuses(@{variables('Cancellation Requested Substatus GUID')})"},"authentication":"@parameters('$authentication')"}},"Apply_to_each_approval_response":{"foreach":"@if(variables('IsLanguageFrench'), outputs('Start_and_wait_for_an_approval_-_FR')?['body/responses'], outputs('Start_and_wait_for_an_approval_-_EN')?['body/responses'])","actions":{"Create_Cancellation_Request_Response_as_Note":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"annotations","item/subject":"@{if(variables('IsLanguageFrench'), 'Demande d''annulation', 'Cancellation Request')} - @{triggerOutputs()?['body/ovs_selectedreasontext']} - @{if(variables('IsLanguageFrench'), if(equals(outputs('Start_and_wait_for_an_approval_-_FR')?['body/outcome'], 'Approve'), 'Approver', 'Rejeter'), outputs('Start_and_wait_for_an_approval_-_EN')?['body/outcome'])} ","item/notetext":"@{if(variables('IsLanguageFrench'), 'À', 'To')}: @{outputs('Get_User_Requesting_Cancellation')?['body/firstname']} @{outputs('Get_User_Requesting_Cancellation')?['body/lastname']} \n@{if(variables('IsLanguageFrench'), 'De', 'From')}: @{outputs('Get_Work_Owner_Owner')?['body/firstname']} @{outputs('Get_Work_Owner_Owner')?['body/lastname']} \n@{if(variables('IsLanguageFrench'), 'Commentaires', 'Comments')}: @{items('Apply_to_each_approval_response')?['comments']}","item/objectid_msdyn_workorder@odata.bind":"msdyn_workorders(@{outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']})"},"authentication":"@parameters('$authentication')"}},"Check_if_Approver_Response_is_Approve":{"actions":{"Set_Approval_Result_-_Approved":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Approval Result","value":"Approved"}}},"runAfter":{"Create_Cancellation_Request_Response_as_Note":["Succeeded"]},"else":{"actions":{"Set_Approval_Result_-_Rejected":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Approval Result","value":"Rejected"}}}},"expression":{"equals":["@if(variables('IsLanguageFrench'), outputs('Start_and_wait_for_an_approval_-_FR')?['body/outcome'], outputs('Start_and_wait_for_an_approval_-_EN')?['body/outcome'])","Approve"]},"type":"If"}},"runAfter":{"Condition_Check_Language_1":["Succeeded"]},"type":"Foreach"},"Check_Approval_Response_is_equal_to_Approved":{"actions":{"Update_Work_Order_to_reflect_Approved_Cancellation":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"msdyn_workorders","recordId":"@outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']","item/msdyn_systemstatus":690970005,"item/statecode":1,"item/statuscode":918640000},"authentication":"@parameters('$authentication')"}},"Send_an_email_(V2)_2":{"runAfter":{"Update_Work_Order_to_reflect_Approved_Cancellation":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"TDGNationalOversightPlan-PlanNationaldeSurveillanceTMD@tc.gc.ca","emailMessage/Subject":"Work Order @{outputs('Update_Substatus_of_Work_Order')?['body/msdyn_name']} - Cancellation Notification","emailMessage/Body":"<p>This email is to notify you of an approval for cancellation that occurred for the Work Order @{outputs('Update_Substatus_of_Work_Order')?['body/msdyn_name']}<br>\n<br>\nWork Order: @{outputs('Update_Work_Order_to_reflect_Approved_Cancellation')?['body/msdyn_name']}<br>\nReason: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@{triggerOutputs()?['body/_ovs_cancellationrequestreason_label']}<br>\nComments: @{triggerOutputs()?['body/ovs_cancellationrequuestcomments']}</p>"},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Apply_to_each_approval_response":["Succeeded"]},"expression":{"equals":["@variables('Approval Result')","Approved"]},"type":"If"},"Unrelate_Cancellation_Requested_Substatus_from_Work_Order":{"runAfter":{"Check_Approval_Response_is_equal_to_Approved":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"DisassociateEntities","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"msdyn_workordersubstatuses","recordId":"@variables('Cancellation Requested Substatus GUID')","associationEntityRelationship":"msdyn_msdyn_workordersubstatus_msdyn_workorder_Status","$id":"@outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']"},"authentication":"@parameters('$authentication')"}},"Get_Owner's_Manager":{"runAfter":{"Get_Work_Owner_Owner":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@outputs('Get_Work_Owner_Owner')?['body/_parentsystemuserid_value']"},"authentication":"@parameters('$authentication')"}},"Get_Related_Work_Order":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_3","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"msdyn_workorders","recordId":"@triggerOutputs()?['body/_regardingobjectid_value']"},"authentication":"@parameters('$authentication')"}},"IsLanguageFrench":{"runAfter":{"Initialize_variable":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"IsLanguageFrench","type":"boolean","value":"@not(equals(triggerOutputs()?['body/ovs_uidescription'], 'en'))"}]}},"Condition_Check_Language_1":{"actions":{"Start_and_wait_for_an_approval_-_FR":{"runAfter":{},"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_approvals","operationId":"StartAndWaitForAnApproval","apiId":"/providers/Microsoft.PowerApps/apis/shared_approvals"},"parameters":{"approvalType":"Basic","WebhookApprovalCreationInput/title":"Ordre de travail @{outputs('Update_Substatus_of_Work_Order')?['body/msdyn_name']} - demande d'annulation","WebhookApprovalCreationInput/assignedTo":"@{outputs('Get_Owner''s_Manager')?['body/internalemailaddress']};","WebhookApprovalCreationInput/details":"*Justification*: @{triggerOutputs()?['body/ovs_selectedreasontext']}\n*Commentaires*: @{triggerOutputs()?['body/ovs_cancellationrequuestcomments']}","WebhookApprovalCreationInput/itemLink":"@{variables('Base Work Order URL')}@{outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']}","WebhookApprovalCreationInput/itemLinkDescription":"Cliquez ici pour voir l'ordre de travail","WebhookApprovalCreationInput/enableNotifications":true,"WebhookApprovalCreationInput/enableReassignment":true},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Update_Substatus_of_Work_Order":["Succeeded"]},"else":{"actions":{"Start_and_wait_for_an_approval_-_EN":{"runAfter":{},"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_approvals","operationId":"StartAndWaitForAnApproval","apiId":"/providers/Microsoft.PowerApps/apis/shared_approvals"},"parameters":{"approvalType":"Basic","WebhookApprovalCreationInput/title":"Work Order @{outputs('Update_Substatus_of_Work_Order')?['body/msdyn_name']} - Request for Cancellation","WebhookApprovalCreationInput/assignedTo":"@{outputs('Get_Owner''s_Manager')?['body/internalemailaddress']};","WebhookApprovalCreationInput/details":"*Rational*: @{triggerOutputs()?['body/ovs_selectedreasontext']}\n*Comments*: @{triggerOutputs()?['body/ovs_cancellationrequuestcomments']}","WebhookApprovalCreationInput/itemLink":"@{variables('Base Work Order URL')}@{outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']}","WebhookApprovalCreationInput/itemLinkDescription":"Click here to view Work Order","WebhookApprovalCreationInput/enableNotifications":true,"WebhookApprovalCreationInput/enableReassignment":true},"authentication":"@parameters('$authentication')"}}}},"expression":{"equals":["@variables('IsLanguageFrench')",true]},"type":"If"},"Condition_Check_Language_2":{"actions":{"Apply_to_each_2":{"foreach":"@outputs('Start_and_wait_for_an_approval_-_FR')?['body/responses']","actions":{"Send_an_email_(V2)_3":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@outputs('Get_User_Requesting_Cancellation')?['body/internalemailaddress']","emailMessage/Subject":"Demande d'annulation @{variables('Approval Result')}","emailMessage/Body":"<p>Ordre de travail @{outputs('Get_Related_Work_Order')?['body/msdyn_name']} a été &nbsp;@{variables('Approval Result')} pour l'annulation.<br>\n<br>\nCommentaires: @{items('Apply_to_each_2')?['comments']}<br>\n<br>\n@{variables('Base Work Order URL')}@{outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']}</p>"},"authentication":"@parameters('$authentication')"}}},"runAfter":{},"type":"Foreach"}},"runAfter":{"Unrelate_Cancellation_Requested_Substatus_from_Work_Order":["Succeeded"]},"else":{"actions":{"Apply_to_each":{"foreach":"@outputs('Start_and_wait_for_an_approval_-_EN')?['body/responses']","actions":{"Send_an_email_(V2)":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@outputs('Get_User_Requesting_Cancellation')?['body/internalemailaddress']","emailMessage/Subject":"Request for Cancellation @{variables('Approval Result')}","emailMessage/Body":"<p>Work Order @{outputs('Get_Related_Work_Order')?['body/msdyn_name']} has been @{variables('Approval Result')} for Cancellation.<br>\n<br>\nComments: @{items('Apply_to_each')?['comments']}<br>\n<br>\n@{variables('Base Work Order URL')}@{outputs('Get_Related_Work_Order')?['body/msdyn_workorderid']}</p>"},"authentication":"@parameters('$authentication')"}}},"runAfter":{},"type":"Foreach"}}},"expression":{"equals":["@variables('IsLanguageFrench')",true]},"type":"If"}},"outputs":{}}},"schemaVersion":"1.0.0.0"}